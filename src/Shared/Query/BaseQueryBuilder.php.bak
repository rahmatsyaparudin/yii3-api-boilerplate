<?php

declare(strict_types=1);

namespace App\Shared\Query;

use Yiisoft\Db\Connection\ConnectionInterface;
use Yiisoft\Db\Query\Query;

/**
 * Base Query Builder for all domains
 * 
 * Menyediakan common query functionality:
 * - Filter application
 * - Sorting
 * - Pagination
 * - Counting
 */
abstract class BaseQueryBuilder
{
    public function __construct(
        protected ConnectionInterface $db,
        protected string $tableName,
        protected string $tableAlias = 't'
    ) {}

    /**
     * Build base query
     */
    protected function buildBaseQuery(): Query
    {
        return (new Query($this->db))
            ->from([$this->tableAlias => $this->tableName])
            ->select(["{$this->tableAlias}.*"]);
    }

    /**
     * Apply filters to query
     */
    protected function applyFilters(Query $query, array $criteria): void
    {
        foreach ($criteria as $key => $value) {
            if ($value === null) {
                continue;
            }

            switch ($key) {
                case 'search':
                    $this->applySearchFilter($query, $value);
                    break;
                case 'ids':
                    $query->andWhere(["in", "{$this->tableAlias}.id", $value]);
                    break;
                default:
                    $query->andWhere(["{$this->tableAlias}.{$key}" => $value]);
                    break;
            }
        }
    }

    /**
     * Apply search filter (search in multiple fields)
     */
    protected function applySearchFilter(Query $query, string $search): void
    {
        $searchableFields = $this->getSearchableFields();
        $conditions = [];
        
        foreach ($searchableFields as $field) {
            $conditions[] = ['like', "{$this->tableAlias}.{$field}", $search];
        }
        
        if (!empty($conditions)) {
            $query->andWhere(['or', ...$conditions]);
        }
    }

    /**
     * Apply sorting to query
     */
    protected function applySorting(Query $query, ?SortOrder $sortOrder = null): void
    {
        if ($sortOrder === null) {
            $query->orderBy(["{$this->tableAlias}.{$this->getDefaultSortField()}" => SORT_ASC]);
            return;
        }

        $direction = $sortOrder->direction === SortOrder::ASC ? SORT_ASC : SORT_DESC;
        $field = $this->validateSortField($sortOrder->field);
        
        $query->orderBy(["{$this->tableAlias}.{$field}" => $direction]);
    }

    /**
     * Apply pagination to query
     */
    protected function applyPagination(Query $query, ?Pagination $pagination = null): void
    {
        if ($pagination !== null) {
            $query->offset($pagination->getOffset())
                  ->limit($pagination->limit);
        }
    }

    /**
     * Get total count for pagination
     */
    protected function getTotalCount(Query $query): int
    {
        $countQuery = clone $query;
        return $countQuery->count();
    }

    /**
     * Get searchable fields (override in child class)
     */
    protected function getSearchableFields(): array
    {
        return ['name']; // Default searchable field
    }

    /**
     * Get default sort field (override in child class)
     */
    protected function getDefaultSortField(): string
    {
        return 'name'; // Default sort field
    }

    /**
     * Validate sort field (override in child class)
     */
    protected function validateSortField(string $field): string
    {
        $allowedFields = $this->getSortableFields();
        
        if (!in_array($field, $allowedFields)) {
            return $this->getDefaultSortField();
        }
        
        return $field;
    }

    /**
     * Get sortable fields (override in child class)
     */
    protected function getSortableFields(): array
    {
        return ['id', 'name', 'created_at', 'updated_at']; // Default sortable fields
    }

    /**
     * Build complete query with filters, sorting, and pagination
     */
    public function buildQuery(
        array $criteria = [],
        ?SortOrder $sortOrder = null,
        ?Pagination $pagination = null
    ): Query {
        $query = $this->buildBaseQuery();
        
        $this->applyFilters($query, $criteria);
        $this->applySorting($query, $sortOrder);
        $this->applyPagination($query, $pagination);
        
        return $query;
    }

    /**
     * Execute query and return paginated results
     */
    public function executeQuery(
        array $criteria = [],
        ?SortOrder $sortOrder = null,
        ?Pagination $pagination = null
    ): array {
        $query = $this->buildQuery($criteria, $sortOrder, $pagination);
        
        $total = $this->getTotalCount($query);
        $rows = $query->all();
        
        return [
            'items' => $rows,
            'total' => $total,
            'page' => $pagination?->page ?? 1,
            'limit' => $pagination?->limit ?? 20,
        ];
    }
}
