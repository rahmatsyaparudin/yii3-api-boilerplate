<?php

declare(strict_types=1);

namespace App\Shared\Repository;

use Yiisoft\Db\Connection\ConnectionInterface;
use Yiisoft\Db\Query\Query;

/**
 * Base Repository for all domain repositories
 * 
 * Menyediakan common repository functionality:
 * - CRUD operations
 * - Query execution
 * - Mapping
 * - Transaction handling
 */
abstract class BaseRepository
{
    public function __construct(
        protected ConnectionInterface $db,
        protected string $tableName,
        protected string $tableAlias = 't'
    ) {}

    /**
     * Find by ID
     */
    public function findById(int $id): ?array
    {
        return (new Query($this->db))
            ->from([$this->tableAlias => $this->tableName])
            ->where(["{$this->tableAlias}.id" => $id])
            ->one();
    }

    /**
     * Find by name
     */
    public function findByName(string $name): ?array
    {
        return (new Query($this->db))
            ->from([$this->tableAlias => $this->tableName])
            ->where(["{$this->tableAlias}.name" => $name])
            ->one();
    }

    /**
     * Check if entity exists by name
     */
    public function existsByName(string $name): bool
    {
        $count = (new Query($this->db))
            ->from([$this->tableAlias => $this->tableName])
            ->where(["{$this->tableAlias}.name" => $name])
            ->count();

        return $count > 0;
    }

    /**
     * Insert new record
     */
    public function insert(array $data): int
    {
        return $this->db->createCommand()
            ->insert($this->tableName, $data)
            ->execute();
    }

    /**
     * Update record
     */
    public function update(int $id, array $data): int
    {
        return $this->db->createCommand()
            ->update($this->tableName, $data, ['id' => $id])
            ->execute();
    }

    /**
     * Delete record
     */
    public function delete(int $id): int
    {
        return $this->db->createCommand()
            ->delete($this->tableName, ['id' => $id])
            ->execute();
    }

    /**
     * Count records
     */
    public function count(array $criteria = []): int
    {
        $query = (new Query($this->db))
            ->from($this->tableName);

        foreach ($criteria as $field => $value) {
            $query->where([$field => $value]);
        }

        return $query->count();
    }

    /**
     * Get database connection for custom queries
     */
    public function getDb(): ConnectionInterface
    {
        return $this->db;
    }

    /**
     * Get table name
     */
    protected function getTableName(): string
    {
        return $this->tableName;
    }

    /**
     * Get table alias
     */
    protected function getTableAlias(): string
    {
        return $this->tableAlias;
    }

    /**
     * Begin transaction
     */
    public function beginTransaction(): void
    {
        $this->db->beginTransaction();
    }

    /**
     * Commit transaction
     */
    public function commitTransaction(): void
    {
        $this->db->commit();
    }

    /**
     * Rollback transaction
     */
    public function rollbackTransaction(): void
    {
        $this->db->rollBack();
    }

    /**
     * Execute query within transaction
     */
    public function executeInTransaction(callable $callback): mixed
    {
        $this->beginTransaction();
        
        try {
            $result = $callback();
            $this->commitTransaction();
            return $result;
        } catch (\Exception $e) {
            $this->rollbackTransaction();
            throw $e;
        }
    }

    /**
     * Build select query
     */
    protected function buildQuery(): Query
    {
        return (new Query($this->db))
            ->from([$this->tableAlias => $this->tableName])
            ->select(["{$this->tableAlias}.*"]);
    }

    /**
     * Apply filters to query
     */
    protected function applyFilters(Query $query, array $criteria): void
    {
        foreach ($criteria as $field => $value) {
            if ($value !== null) {
                $query->where(["{$this->tableAlias}.{$field}" => $value]);
            }
        }
    }

    /**
     * Apply sorting to query
     */
    protected function applySorting(Query $query, array $sort): void
    {
        foreach ($sort as $field => $direction) {
            $direction = $direction === 'desc' ? SORT_DESC : SORT_ASC;
            $query->orderBy(["{$this->tableAlias}.{$field}" => $direction]);
        }
    }

    /**
     * Apply pagination to query
     */
    protected function applyPagination(Query $query, int $offset, int $limit): void
    {
        $query->offset($offset)->limit($limit);
    }
}
