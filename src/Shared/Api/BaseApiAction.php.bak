<?php

declare(strict_types=1);

namespace App\Shared\Api;

use App\Api\Shared\ResponseFactory;
use App\Shared\Request\RequestParams;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Yiisoft\Http\Status;
use Yiisoft\Router\CurrentRoute;
use App\Shared\Validation\RequestValidator;

/**
 * Base API Action for all domain actions
 * 
 * Menyediakan common functionality yang sering digunakan:
 * - Request parameter extraction
 * - Error handling
 * - Response formatting
 * - Validation
 */
abstract class BaseApiAction
{
    public function __construct(
        protected ResponseFactory $responseFactory
    ) {}

    /**
     * Extract ID from route parameter
     */
    protected function getIdFromRoute(CurrentRoute $currentRoute): int
    {
        $id = $currentRoute->getArgument('id');
        
        if ($id === null) {
            return $this->fail(
                message: 'route.parameter_missing',
                params: [
                    'resource' => $this->getResourceName(),
                    'parameter' => 'id',
                ],
                httpCode: Status::NOT_FOUND
            );
        }

        return (int) $id;
    }

    /**
     * Get request payload
     */
    protected function getPayload(ServerRequestInterface $request): RequestParams
    {
        /** @var \App\Shared\Request\RequestParams $payload */
        return $request->getAttribute('payload');
    }

    /**
     * Validate ID parameter
     */
    protected function validateId(int $id): ResponseInterface|null
    {
        if (!$id) {
            return $this->fail(
                message: "{$this->getResourceName()} ID is required",
                httpCode: Status::NOT_FOUND
            );
        }
        return null;
    }

    /**
     * Extract and validate parameters
     */
    protected function extractParams(ServerRequestInterface $request, array $allowedKeys = []): array
    {
        $payload = $this->getPayload($request);
        
        if ($allowedKeys) {
            return RequestValidator::onlyAllowed(
                filters: $payload->getRawParams(),
                allowedKeys: $allowedKeys
            )->toArray();
        }
        
        return $payload->getRawParams()->toArray();
    }

    /**
     * Format success response
     */
    protected function success(
        array $data,
        ?array $translate = null,
        ?array $meta = null
    ): ResponseInterface {
        return $this->responseFactory->success(
            data: $data,
            translate: $translate ?? [
                'key' => 'resource.operation_success',
                'params' => [
                    'resource' => $this->getResourceName(),
                    'operation' => $this->getOperationName()
                ]
            ],
            meta: $meta
        );
    }

    /**
     * Format error response
     */
    protected function fail(
        string $message = '',
        int $httpCode = 400
    ): ResponseInterface {
        return $this->responseFactory->fail(
            message: $message,
            httpCode: $httpCode
        );
    }

    /**
     * Format created response
     */
    protected function created(array $data): ResponseInterface
    {
        return $this->responseFactory->success(
            data: $data,
            translate: [
                'key' => 'resource.created',
                'params' => [
                    'resource' => $this->getResourceName()
                ]
            ]
        );
    }

    /**
     * Format updated response
     */
    protected function updated(array $data): ResponseInterface
    {
        return $this->responseFactory->success(
            data: $data,
            translate: [
                'key' => 'resource.updated',
                'params' => [
                    'resource' => $this->getResourceName()
                ]
            ]
        );
    }

    /**
     * Format deleted response
     */
    protected function deleted(): ResponseInterface
    {
        return $this->responseFactory->success(
            data: [],
            translate: [
                'key' => 'resource.deleted',
                'params' => [
                    'resource' => $this->getResourceName()
                ]
            ]
        );
    }

    /**
     * Format list response
     */
    protected function listResponse(
        array $items,
        array $paginationMeta,
        ?array $filter = null,
        ?array $sort = null
    ): ResponseInterface {
        return $this->responseFactory->success(
            data: $items,
            translate: [
                'key' => 'resource.list_retrieved',
                'params' => [
                    'resource' => $this->getResourceName()
                ]
            ],
            meta: [
                'pagination' => $paginationMeta,
                'filter' => $filter,
                'sort' => $sort,
            ]
        );
    }

    /**
     * Format details response
     */
    protected function detailsResponse(array $data): ResponseInterface
    {
        return $this->responseFactory->success(
            data: $data,
            translate: [
                'key' => 'resource.details_retrieved',
                'params' => [
                    'resource' => $this->getResourceName()
                ]
            ]
        );
    }

    /**
     * Get resource name for translations
     * Override in child class
     */
    protected function getResourceName(): string
    {
        return 'Resource';
    }

    /**
     * Get operation name for translations
     * Override in child class
     */
    protected function getOperationName(): string
    {
        return 'operation';
    }
}
